openapi: 3.0.3
info:
  title: FlowPilot AuthZ API
  version: "1.0.0"
  description: >
    Authorization integration service with PDP faÃ§ade and authorization graph writer.
    
    **Responsibilities**:
    - Policy evaluation using OPA rego policy (PDP)
    - Authorization graph maintenance
    
    Implements AuthZEN-compliant request structure. This service is stateless and does not maintain any in-memory storage.
    
    **Security**: All endpoints (except /health) require bearer token authentication.
    
    **TLS**: Services use HTTP within the Docker network. For production, deploy behind
    a TLS-terminating reverse proxy (nginx, Traefik, etc.).
servers:
  - url: http://127.0.0.1:8002
    description: Local development access
  - url: http://flowpilot-authz-api:8002
    description: Docker network (internal)
security:
  - BearerAuth: []
paths:
  /health:
    get:
      summary: Health check
      security: []  # No authentication required for health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              examples:
                ok:
                  value:
                    status: ok

  /v1/evaluate:
    post:
      summary: Evaluate authorization decision (AuthZEN-like)
      security:
        - BearerAuth: []
      description: >
        Evaluates whether a subject (agent or user) may perform an action on a resource.
        Uses AuthZEN-like structure with subject/action/resource/context/options.
        
        Supported actions:
        - create: Create a new workflow
        - read: View workflows
        - execute: Execute workflow items (book travel)
        - update: Update workflow items
        - delete: Delete workflow items
        - validate_persona: Check if a persona is valid (active status, within time range)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EvaluateRequest"
            examples:
              canExecuteItem:
                value:
                  subject:
                    type: agent
                    id: agent_flowpilot_1
                    properties:
                      persona: domain-service
                  action:
                    name: book
                    properties: {}
                  resource:
                    type: workflow_item
                    id: i_f032d0a2
                    properties:
                      workflow_id: t_4a6455a3
                      domain: flowpilot
                  context:
                    principal:
                      id: 1460e175-74f9-43af-aac3-7b4fc0547f05
                    attributes: {}
                  options:
                    dry_run: true
                    explain: true
              validatePersona:
                value:
                  subject:
                    type: user
                    id: 1460e175-74f9-43af-aac3-7b4fc0547f05
                    properties:
                      persona: traveler
                  action:
                    name: validate_persona
                  resource:
                    type: persona
                    id: "persona:1460e175-74f9-43af-aac3-7b4fc0547f05:traveler"
                  context:
                    principal:
                      id: 1460e175-74f9-43af-aac3-7b4fc0547f05
                      persona: traveler
                      persona_status: active
                      persona_valid_from: "2024-01-01T00:00:00Z"
                      persona_valid_till: "2025-12-31T23:59:59Z"
                  options:
                    dry_run: true
                    explain: true
      responses:
        "200":
          description: Decision
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EvaluateResponse"
              examples:
                deny:
                  value:
                    decision: deny
                    reason_codes: [rego.deny]
                    advice:
                      - type: deny
                        message: "Denied by rego policy."
                allow:
                  value:
                    decision: allow
                    reason_codes: []
                    advice: []
        "400":
          description: Bad request / downstream failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
      required: [status]

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required: [detail]

    Advice:
      type: object
      properties:
        type:
          type: string
          description: Advice category (deny, error, info, profile_missing)
        message:
          type: string
      required: [type, message]

    # AuthZEN-like models
    Subject:
      type: object
      description: Actor performing the action (agent or user)
      properties:
        type:
          type: string
          description: Actor type (agent, user)
          example: agent
        id:
          type: string
          description: Actor identifier (agent_sub or user_sub)
          example: agent_flowpilot_1
        properties:
          type: object
          description: Subject properties (persona, etc.)
          properties:
            persona:
              type: string
              description: Persona/role of the subject
              example: domain-service
          additionalProperties: true
      required: [type, id]
      additionalProperties: true

    Action:
      type: object
      description: Action being performed
      properties:
        name:
          type: string
          description: Action name (book, execute, approve, etc.)
          example: book
        properties:
          type: object
          description: Action-specific properties
          additionalProperties: true
      required: [name]
      additionalProperties: true

    Resource:
      type: object
      description: Resource being acted upon
      properties:
        type:
          type: string
          description: Resource type (workflow, workflow_item, etc.)
          example: workflow_item
        id:
          type: string
          description: Resource identifier
          example: i_f032d0a2
        properties:
          type: object
          description: Resource-specific properties (workflow_id, domain, etc.)
          additionalProperties: true
      required: [type, id]
      additionalProperties: true

    Context:
      type: object
      description: Request context including principal
      properties:
        principal:
          type: object
          description: Principal on whose behalf action is performed
          properties:
            id:
              type: string
              description: Principal subject UUID
              example: 1460e175-74f9-43af-aac3-7b4fc0547f05
          additionalProperties: true
        attributes:
          type: object
          description: Additional context attributes
          additionalProperties: true
      additionalProperties: true

    Options:
      type: object
      description: Evaluation options
      properties:
        dry_run:
          type: boolean
          description: If true, simulate without side effects
          default: true
        explain:
          type: boolean
          description: If true, include debug traces
          default: true
        trace:
          type: boolean
          description: Override trace behavior
      additionalProperties: true

    EvaluateRequest:
      type: object
      properties:
        subject:
          $ref: "#/components/schemas/Subject"
        action:
          $ref: "#/components/schemas/Action"
        resource:
          $ref: "#/components/schemas/Resource"
        context:
          $ref: "#/components/schemas/Context"
        options:
          $ref: "#/components/schemas/Options"
      required: [subject, action, resource]
      additionalProperties: true

    EvaluateResponse:
      type: object
      properties:
        decision:
          type: string
          description: allow or deny
          enum: [allow, deny]
        reason_codes:
          type: array
          items:
            type: string
          description: Machine-readable reason codes
        advice:
          type: array
          items:
            $ref: "#/components/schemas/Advice"
          description: Human-readable advice hints
      required: [decision, reason_codes, advice]

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >
        JWT bearer token for authentication.
        
        **Local Development (Docker Compose):**
        - JWT from Keycloak OIDC provider
        - Service-to-service calls use client credentials grant
        
        **GCP Cloud Run:**
        - User tokens: Firebase ID tokens (RS256)
        - Service tokens: HS256 JWTs with shared secret
        
        Example: `Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...`
